<!doctype html>
<html>
    <head>
        <script src="https://unpkg.com/srcsjs@0.0.4/s.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
        <script>
            const firebaseConfig = {
            apiKey: "AIzaSyAc6auE0SXo6wAoOtHEFxY9kbxW8BIaVJs",
            authDomain: "gedisfoto.firebaseapp.com",
            databaseURL: "https://gedisfoto-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gedisfoto",
            storageBucket: "gedisfoto.appspot.com",
            messagingSenderId: "140642487007",
            appId: "1:140642487007:web:0e38e6d4b82177fee5f76a"
            };

            firebase.initializeApp(firebaseConfig)
            const db = firebase.database()
            const auth = firebase.auth()
            const www = db.ref('w')
            www.on('value', setW)
            var w = {}

            auth.onAuthStateChanged(user => {
                if(user) {
                    show('editor')
                    hide('login')
                }
                else {
                    show('login')
                }
            })

            function login() {
                const email = e('email').innerText
                const password = e('password').innerText
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        hide('login')
                        show('editor')
                    })
                    .catch((error) => {
                        notify(error.message)
                    });
            }

            function setW(data) {
                w = data.val()
                console.log(w)
                load(w)
            }

        </script>
        <title>editor</title>
        <meta name="description" content="Editor">
        <link rel="stylesheet" href="/s.css">
    </head>
    <body>
        <main>
            <div style="text-align: center;" id="login" style="display: none;">
                <label>Email</label>
                <div contenteditable="true" id="email"></div>
                <label>Password</label>
                <div contenteditable="true" id="password" ></div>
                <div class="action" onclick="login()">Login</div>
            </div>

            <div id="editor" style="display: none;">
                <div class="df">                    
                    <div class="link" onclick="show('head'); hide('body')">
                        head
                    </div>
                    <div class="link" onclick="show('body'); hide('head')">
                        body
                    </div>
                </div>
                <div>
                    <div id="head">
       
                    </div>
                    <div id="body" style="display: none;">
          
                    </div>
                </div>
                <div class="action" onclick="save()" style="position: fixed; bottom: 0;">save</div>
            </div>
        </main>

        <script id="loader">
            const ed = e('editor')

            function load(w) {
                ih(e('head'), '')
                for(index in w.head) {
                    add(qe(ed, '#head'), coe(w.head[index], ))
                }
                ih(e('body'), '')
                for(item of w.body) {
                    add(qe(ed, '#body'), coe(item))
                }

            }

            function build() {
                var b = {
                    head: [],
                    body: []
                }

                for(hi of qe(ed, '#head').children) {
                    b.head.push(JSON.parse(ga(hi, 'o')))
                }

                for(bi of qe(ed, '#body').children) {
                    b.body.push(JSON.parse(ga(bi, 'o')))
                }

                return b
                
            }

            function preview() {
                t(e('export'), JSON.stringify(w))
            }

            function save() {
                const b = build()
                console.log(b)
                www.update(b)
            }

            function coe(obj) {
                return ce({
                    a: {o: JSON.stringify(obj)},
                    cl: 'object_element',
                    c: [
                        {
                            cl: 'tabs',
                            c: [
                                {
                                    a: { onclick: '' },
                                    t: obj.e || 'div'
                                },
                                {
                                    a: { onclick: 'eTab(gp(this), "id")' },
                                    t: 'ID'
                                },
                                {
                                    a: { onclick: 'eTab(gp(this), "s")' },
                                    t: 'S'
                                },
                                {
                                    a: { onclick: 'eTab(gp(this), "a")' },
                                    t: 'A'
                                },
                                {
                                    a: { onclick: 'eTab(gp(this), "c")' },
                                    t: 'C'
                                },
                            ]
                        },
                        {
                            cl: 'tab',
                            t: obj.t
                        }
                    ]
                })
            }

            function eTab(el, t) {
                const tab = qe(el, '.tab')
                const o = JSON.parse(ga(el, 'o'))
                ih(tab, '')

                var content = c('div')
                
                switch(t) {
                    case 'id':
                        a(content, 'contenteditable', true)
                        a(content, 'onkeyup', 'updateOE(gp(this), "id", this.innerText)')
                        o.id ? t(content, o.id) : ''
                        break;

                    case 'e':
                        break;

                    case 'a':
                        for(atr in o.a) {
                            add(content, ce({cl: 'atr df', c:[{a: {contenteditable: "true"}, cl: 'akey', t: atr}, {a: {contenteditable: "true"}, cl: 'aval', t: o.a[atr]}]}))
                        }

                }

                add(tab, content)
            }

            function updateOE(oe, atr, value) {
                var o = JSON.parse(ga(oe, 'o'))
                value && value !== '\n' ? o[atr] = value : delete o[atr]
                a(oe, 'o', JSON.stringify(o))
            }

        </script>
    </body>
</html>